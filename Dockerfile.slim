# =============================================================================
# Multi-stage Dockerfile for OpenClaw Gateway (Agentivo optimized)
#
# Target: ~600 MB runtime image (down from 6.4 GB original)
#
# Key optimizations:
# 1. Multi-stage build (builder for compilation, slim runtime)
# 2. COPY --chown instead of RUN chown -R (saves ~1.4 GB layer duplication)
# 3. Strip node-llama-cpp binaries post-prune (saves ~712 MB)
# 4. Strip other gateway-unnecessary native modules
# 5. Clean metadata files from node_modules
# =============================================================================

# ----- Stage 1: Builder -----
FROM node:22-bookworm AS builder

# Install Bun (required for build scripts)
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

RUN corepack enable

WORKDIR /app

# Install all dependencies (including dev — needed for build)
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY ui/package.json ./ui/package.json
COPY patches ./patches
COPY scripts ./scripts

RUN pnpm install --frozen-lockfile

# Copy source and build
COPY . .
RUN pnpm build
ENV OPENCLAW_PREFER_PNPM=1
RUN pnpm ui:build

# Prune dev dependencies — keep only production deps
RUN CI=true pnpm prune --prod

# ---------------------------------------------------------------------------
# Strip packages not needed for gateway-only mode.
# These are production deps in OpenClaw's package.json but unused when
# running as an embedded gateway (we use cloud LLM APIs, not local inference).
# ---------------------------------------------------------------------------
RUN set -ex && \
    # node-llama-cpp: ~712 MB of local LLM inference binaries (CUDA, Vulkan, etc.)
    rm -rf \
      node_modules/.pnpm/@node-llama-cpp* \
      node_modules/.pnpm/node-llama-cpp* \
      node_modules/node-llama-cpp \
      node_modules/@node-llama-cpp && \
    # @napi-rs/canvas: ~62 MB image generation (not needed for chat gateway)
    rm -rf \
      node_modules/.pnpm/@napi-rs+canvas* \
      node_modules/@napi-rs/canvas && \
    # @lancedb: ~144 MB vector database (not needed for gateway)
    rm -rf \
      node_modules/.pnpm/@lancedb* \
      node_modules/@lancedb && \
    # playwright-core: ~10 MB browser automation (not needed for gateway)
    rm -rf \
      node_modules/.pnpm/playwright-core* \
      node_modules/playwright-core && \
    # Remove musl-specific sharp binaries (runtime is glibc-based Debian slim)
    rm -rf \
      node_modules/.pnpm/@img+sharp-libvips-linuxmusl* \
      node_modules/.pnpm/@napi-rs+canvas-linux-x64-musl* && \
    # Remove non-x64 architecture binaries (Fly.io machines are x64)
    rm -rf \
      node_modules/.pnpm/*-linux-arm64* \
      node_modules/.pnpm/*-linux-armv7l* \
      node_modules/.pnpm/*-linux-s390x* \
      node_modules/.pnpm/*-linux-ppc64* && \
    # Clean metadata from remaining node_modules
    find node_modules \( \
      -name "CHANGELOG*" -o \
      -name "HISTORY*" -o \
      -name "*.map" -o \
      -name "*.ts" ! -name "*.d.ts" -o \
      -name "tsconfig*.json" -o \
      -name ".eslintrc*" -o \
      -name ".prettierrc*" \
    \) -delete 2>/dev/null; \
    echo "Cleanup complete"


# ----- Stage 2: Runtime -----
FROM node:22-slim

WORKDIR /app

# Copy with --chown to set ownership at copy time (avoids 1.4 GB chown layer)
COPY --from=builder --chown=node:node /app/openclaw.mjs ./
COPY --from=builder --chown=node:node /app/package.json ./
COPY --from=builder --chown=node:node /app/dist ./dist
COPY --from=builder --chown=node:node /app/ui ./ui
COPY --from=builder --chown=node:node /app/node_modules ./node_modules
COPY --from=builder --chown=node:node /app/patches ./patches
COPY --from=builder --chown=node:node /app/docs/reference/templates ./docs/reference/templates

ENV NODE_ENV=production
ENV OPENCLAW_PREFER_PNPM=1

# Run as non-root (no chown -R needed — already owned by node)
USER node

CMD ["node", "openclaw.mjs", "gateway", "--allow-unconfigured"]
